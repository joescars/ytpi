<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Download Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .main-container { display: flex; min-height: 100vh; }
    .left-panel { flex: 2; padding: 2em; }
    .right-panel { flex: 2; background: #fff; border-left: 1px solid #ddd; padding: 2em 1em; min-width: 450px; box-shadow: -2px 0 8px rgba(0,0,0,0.03); }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 0.5em; border: 1px solid #ccc; }
    th { background: #f0f0f0; }
    .error { color: red; }
    .job-link { cursor: pointer; color: #007bff; text-decoration: underline; }
    .job-link.active { font-weight: bold; color: #0056b3; }
    pre { background: #222; color: #eee; padding: 1em; border-radius: 6px; overflow-x: auto; max-height: 60vh; white-space: pre-wrap; word-break: break-word; }
    @media (max-width: 900px) {
      .main-container { flex-direction: column; }
      .right-panel { min-width: unset; border-left: none; border-top: 1px solid #ddd; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="left-panel">
      <h1>Download Job Status</h1>
      <a href="/" style="margin-bottom: 20px; display: inline-block;">Back to Home</a>
      {% if not jobs %}
        <p>No download jobs found.</p>
      {% endif %}
      <table>
        <tr>
          <th>Job ID</th>
          <th>URL</th>
          <th>Status</th>
          <th>Error</th>
        </tr>
        {% for jid, info in jobs.items() %}
        <tr>
          <td><span class="job-link" data-jobid="{{ jid }}">{{ jid[:8] }}</span></td>
          <td><a href="{{ info.url }}" target="_blank">{{ info.url }}</a></td>
          <td>{{ info.status }}</td>
          <td class="error">{{ info.get('error', '') }}</td>
        </tr>
        {% endfor %}
      </table>
      <p>Click a Job ID to view live output. Refresh the page to see updates.</p>
    </div>
    <div class="right-panel">
      <h2>Live Job Output</h2>
      <div id="output-jobid" style="font-size:0.95em; color:#888; margin-bottom:0.5em;"></div>
      <pre id="job-output">Select a job to view output.</pre>
    </div>
  </div>
  <script>
    const outputPre = document.getElementById('job-output');
    const outputJobId = document.getElementById('output-jobid');
    let pollInterval = null;
    let activeJobId = null;
    function showJobOutput(jobId) {
      activeJobId = jobId;
      outputJobId.textContent = 'Job ID: ' + jobId;
      outputPre.textContent = 'Loading...';
      document.querySelectorAll('.job-link').forEach(link => {
        link.classList.toggle('active', link.dataset.jobid === jobId);
      });
      fetchOutput(jobId);
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(() => fetchOutput(jobId), 2000);
    }
    function fetchOutput(jobId) {
      fetch(`/job_output/${jobId}`)
        .then(r => r.json())
        .then(data => {
          outputPre.textContent = data.output || '(No output yet)';
          outputPre.scrollTop = outputPre.scrollHeight;
        });
    }
    document.querySelectorAll('.job-link').forEach(link => {
      link.addEventListener('click', function() {
        showJobOutput(this.dataset.jobid);
      });
    });
    // Optionally, auto-select the first job if any
    window.onload = function() {
      const first = document.querySelector('.job-link');
      if (first) first.click();
    };
  </script>
</body>
</html>