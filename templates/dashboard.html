<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Download Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.5em; border: 1px solid #ccc; }
    th { background: #f0f0f0; }
    .error { color: red; }
    .modal {
      display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.4); align-items: center; justify-content: center;
    }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 8px; max-width: 700px; width: 90vw; max-height: 80vh; overflow: auto;
    }
    .close { float: right; font-size: 1.5em; cursor: pointer; }
    pre { background: #222; color: #eee; padding: 1em; border-radius: 6px; overflow-x: auto; max-height: 60vh; }
  </style>
</head>
<body>
  <h1>Download Job Status</h1>
  <a href="/" style="margin-bottom: 20px; display: inline-block;">Back to Home</a>
  {% if not jobs %}
    <p>No download jobs found.</p>
  {% endif %}
  <table>
    <tr>
      <th>Job ID</th>
      <th>URL</th>
      <th>Status</th>
      <th>Error</th>
    </tr>
    {% for jid, info in jobs.items() %}
    <tr>
      <td><a href="#" class="job-link" data-jobid="{{ jid }}">{{ jid }}</a></td>
      <td><a href="{{ info.url }}" target="_blank">{{ info.url }}</a></td>
      <td>{{ info.status }}</td>
      <td class="error">{{ info.get('error', '') }}</td>
    </tr>
    {% endfor %}
  </table>
  <p>Click a Job ID to view live output. Refresh the page to see updates.</p>

  <div class="modal" id="output-modal">
    <div class="modal-content">
      <span class="close" id="close-modal">&times;</span>
      <h2>Job Output</h2>
      <pre id="job-output">Loading...</pre>
    </div>
  </div>
  <script>
    const modal = document.getElementById('output-modal');
    const closeModal = document.getElementById('close-modal');
    const outputPre = document.getElementById('job-output');
    let pollInterval = null;
    function showModal(jobId) {
      modal.style.display = 'flex';
      outputPre.textContent = 'Loading...';
      fetchOutput(jobId);
      pollInterval = setInterval(() => fetchOutput(jobId), 2000);
    }
    function hideModal() {
      modal.style.display = 'none';
      outputPre.textContent = '';
      if (pollInterval) clearInterval(pollInterval);
    }
    function fetchOutput(jobId) {
      fetch(`/job_output/${jobId}`)
        .then(r => r.json())
        .then(data => {
          outputPre.textContent = data.output || '(No output yet)';
          // Auto-scroll to bottom
          outputPre.scrollTop = outputPre.scrollHeight;
        });
    }
    document.querySelectorAll('.job-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        showModal(this.dataset.jobid);
      });
    });
    closeModal.onclick = hideModal;
    window.onclick = function(event) {
      if (event.target == modal) hideModal();
    };
  </script>
</body>
</html>